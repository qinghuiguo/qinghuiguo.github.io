I"œ!<ul id="markdown-toc">
  <li><a href="#ä»€ä¹ˆæ˜¯crash-recover" id="markdown-toc-ä»€ä¹ˆæ˜¯crash-recover">ä»€ä¹ˆæ˜¯crash recoverï¼Ÿ</a></li>
  <li><a href="#ä¸ºä»€ä¹ˆè¦è¿›è¡Œcrash-recover" id="markdown-toc-ä¸ºä»€ä¹ˆè¦è¿›è¡Œcrash-recover">ä¸ºä»€ä¹ˆè¦è¿›è¡Œcrash recover</a></li>
  <li><a href="#å®ä¾‹æ¢å¤çš„è¿‡ç¨‹" id="markdown-toc-å®ä¾‹æ¢å¤çš„è¿‡ç¨‹">å®ä¾‹æ¢å¤çš„è¿‡ç¨‹</a></li>
  <li><a href="#æ€»ç»“" id="markdown-toc-æ€»ç»“">æ€»ç»“</a></li>
</ul>

<h2 id="ä»€ä¹ˆæ˜¯crash-recover">ä»€ä¹ˆæ˜¯crash recoverï¼Ÿ</h2>

<blockquote>
  <p>ç”±äºæ•…éšœå¯¼è‡´Instanceå¼‚å¸¸å…³é—­æˆ–ç”±äºæ‰§è¡Œäº†pg_ctl stop -m immediateéƒ½ä¼šå¯¼è‡´æ•°æ®åº“å®ä¾‹åœ¨é‡å¯æ—¶æ‰§è¡Œå®ä¾‹æ¢å¤ï¼Œç”±åå°è¿›ç¨‹å®Œæˆï¼Œä¸éœ€è¦äººå·¥å¹²é¢„,æ¢å¤çš„æ—¶é—´é€šè¿‡max_wal_sizeæ§åˆ¶ã€‚</p>
</blockquote>

<h2 id="ä¸ºä»€ä¹ˆè¦è¿›è¡Œcrash-recover">ä¸ºä»€ä¹ˆè¦è¿›è¡Œcrash recover</h2>

<blockquote>
  <p>æ­£å¸¸è¿è¡ŒæœŸé—´ï¼Œé‡Œé¢å­˜åœ¨å¾ˆå¤šè„å—ï¼Œå¦‚æœå®ä¾‹å¼‚å¸¸ï¼Œå¯¼è‡´è„å—æœªå†™å…¥ç£ç›˜ï¼Œå¦‚æœæ²¡æœ‰ä»€ä¹ˆæ‰‹æ®µæŠŠå´©æºƒåçš„è„å—æ‰¾å›æ¥ï¼Œè‚¯å®šä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚å½“ç„¶å…³ç³»æ•°æ®åº“è®¾è®¡ä¹‹åˆï¼Œè¿™ç§æƒ…å†µå°±å·²ç»è€ƒè™‘äº†ï¼Œé€šè¿‡é‡åšæ—¥å¿—ï¼Œå®Œå…¨å¯ä»¥å®ç°å®ä¾‹crashä¸ä¸¢æ•°æ®ã€‚
æ€»è€Œè¨€ä¹‹ï¼Œæ‰€æœ‰å·²æäº¤çš„äº‹åŠ¡ï¼Œéƒ½æ˜¯å¯ä»¥æ¢å¤çš„ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚</p>
</blockquote>

<h2 id="å®ä¾‹æ¢å¤çš„è¿‡ç¨‹">å®ä¾‹æ¢å¤çš„è¿‡ç¨‹</h2>

<blockquote>
  <p><strong>LSNï¼ˆLog Sequence Number</strong>
walæ—¥å¿—ä¸ºäº†replayçš„æœ‰åºæ€§éœ€è¦åŠ ä¸Šç¼–å·ã€‚å®ç°çš„æ—¶å€™ï¼Œæ˜¯æŒ‰æ—¥å¿—çš„äº§ç”Ÿçš„é¡ºåºå†™å…¥ç£ç›˜çš„ï¼Œå³ä½¿æ˜¯å†™åˆ°ç£ç›˜ç¼“å†²åŒºä¸­ï¼Œä¹Ÿæ˜¯æŒ‰äº§ç”Ÿçš„é¡ºåºä¸€æ¬¡å†™åˆ°æ—¥å¿—ç¼“å†²åŒºä¸­ï¼Œå†å°†æ—¥å¿—é¡ºåºå†™åˆ°ç£ç›˜ã€‚
å› æ­¤é‡‡ç”¨æ—¥å¿—åœ¨æ—¥å¿—æ–‡ä»¶ä¸­çš„åç§»æ¥ä»£æ›¿è¿™ä¸ªæ—¥å¿—ç¼–å·ï¼Œå¯ä»¥é€šè¿‡æ—¥å¿—ç¼–å·è¿…é€Ÿå®šä½åˆ°æ—¥å¿—ã€‚è¿™ä¸ªæ—¥å¿—ç¼–å·å°±å«åšlsnã€‚</p>
</blockquote>

<blockquote>
  <p><strong>æ¢å¤è¿‡ç¨‹</strong>
1ã€åˆå§‹åŒ–å†…å­˜ï¼Œå¯åŠ¨åå°è¿›ç¨‹ã€‚
2ã€pgåœ¨å¯åŠ¨æ—¶è¯»å–pg_controlæ–‡ä»¶å†…å®¹ã€‚å¦‚æœstateä¸ºâ€™in productionâ€™ï¼ŒPostgreSQLå°†è¿›å…¥æ¢å¤æ¨¡å¼ï¼Œå› ä¸ºè¿™æ„å‘³ç€æ•°æ®åº“æ²¡æœ‰æ­£å¸¸åœæ­¢ï¼›å¦‚æœä¸ºâ€™shutdownâ€™ï¼Œå°†è¿›å…¥æ­£å¸¸å¯åŠ¨æ¨¡å¼ã€‚
3ã€pgä»ç›¸åº”çš„WALæ®µæ–‡ä»¶ä¸­è¯»å–æœ€æ–°çš„æ£€æŸ¥ç‚¹è®°å½•ï¼ˆä½äºpg_controlæ–‡ä»¶ä¸­ï¼‰ï¼Œå¹¶ä»è®°å½•ä¸­è·å–é‡åšç‚¹ã€‚å¦‚æœæœ€æ–°çš„æ£€æŸ¥ç‚¹è®°å½•æ— æ•ˆï¼ˆinvalidï¼‰ï¼Œpgå°†è¯»å–å‰ä¸€ä¸ªæ£€æŸ¥ç‚¹çš„è®°å½•ã€‚å¦‚æœä¸¤ä¸ªè®°å½•éƒ½ä¸å¯è¯»ï¼Œå°†æ”¾å¼ƒæ¢å¤ã€‚æ³¨æ„ï¼Œä»11ç‰ˆæœ¬å¼€å§‹ä¸ä¼šå†å­˜å‚¨å‰ä¸€ä¸ªæ£€æŸ¥ç‚¹çš„è®°å½•ä¿¡æ¯ã€‚
4ã€ä½¿ç”¨åˆé€‚çš„èµ„æºç®¡ç†å™¨ä»é‡åšç‚¹å¼€å§‹æŒ‰é¡ºåºè¯»å–å’Œé‡æ”¾XLOGè®°å½•ï¼Œç›´åˆ°æœ€æ–°WALæ–‡ä»¶çš„æœ€åä½ç½®ã€‚å½“é‡åˆ°å¤‡ä»½å—æ—¶ï¼Œæ— è®ºå…¶LSNå¦‚ä½•ï¼Œéƒ½ä¼šå°†è¦†ç›–ç›¸åº”è¡¨çš„é¡µé¢ã€‚å¦åˆ™ä»…å½“æ­¤xlogè®°å½•LSN&gt;ç›¸åº”é¡µé¢çš„pd_lsnæ—¶ï¼Œæ‰ä¼šé‡æ”¾è¯¥XLOGè®°å½•ã€‚</p>
</blockquote>

<p><strong>å¼ºåˆ¶å…³é—­å®ä¾‹</strong>
 pg_ctl stop -m immediate</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2020-10-10 21:25:08.995 CST [2172] LOG:  received immediate shutdown request
2020-10-10 21:25:09.008 CST [2300] WARNING:  terminating connection because of crash of another server process
2020-10-10 21:25:09.008 CST [2300] DETAIL:  The postmaster has commanded this server process to roll back the current transaction and exit, because another server process exited abnormally and possibly corrupted shared memory.
2020-10-10 21:25:09.008 CST [2300] HINT:  In a moment you should be able to reconnect to the database and repeat your command.
2020-10-10 21:25:09.008 CST [2178] WARNING:  terminating connection because of crash of another server process
2020-10-10 21:25:09.008 CST [2178] DETAIL:  The postmaster has commanded this server process to roll back the current transaction and exit, because another server process exited abnormally and possibly corrupted shared memory.
2020-10-10 21:25:09.008 CST [2178] HINT:  In a moment you should be able to reconnect to the database and repeat your command.
2020-10-10 21:25:09.023 CST [2172] LOG:  database system is shut down
</code></pre></div></div>
<blockquote>
  <p>æ£€æŸ¥æ§åˆ¶æ–‡ä»¶çŠ¶æ€
æ£€æŸ¥ç‚¹ä½ç½®ä¸º:1/7F8D4B10</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[postgres@qinghui-pc ~]$ pg_controldata 
pg_control version number:            1100
Catalog version number:               201809051
Database system identifier:           6842561910620900147
Database cluster state:               in production
pg_control last modified:             Sat 10 Oct 2020 09:23:00 PM CST
Latest checkpoint location:           1/7F8D4B10
Latest checkpoint's REDO location:    1/7F8D4B10
Latest checkpoint's REDO WAL file:    00000001000000010000007F
Latest checkpoint's TimeLineID:       1
Latest checkpoint's PrevTimeLineID:   1
Latest checkpoint's full_page_writes: on
Latest checkpoint's NextXID:          0:749
Latest checkpoint's NextOID:          33179
Latest checkpoint's NextMultiXactId:  1
Latest checkpoint's NextMultiOffset:  0
Latest checkpoint's oldestXID:        561
Latest checkpoint's oldestXID's DB:   1
Latest checkpoint's oldestActiveXID:  0
Latest checkpoint's oldestMultiXid:   1
Latest checkpoint's oldestMulti's DB: 13287
Latest checkpoint's oldestCommitTsXid:0
Latest checkpoint's newestCommitTsXid:0
Time of latest checkpoint:            Sat 10 Oct 2020 06:01:16 PM CST
Fake LSN counter for unlogged rels:   0/1
Minimum recovery ending location:     0/0
Min recovery ending loc's timeline:   0
Backup start location:                0/0
Backup end location:                  0/0
End-of-backup record required:        no
wal_level setting:                    replica
wal_log_hints setting:                off
max_connections setting:              100
max_worker_processes setting:         8
max_prepared_xacts setting:           0
max_locks_per_xact setting:           64
track_commit_timestamp setting:       off
Maximum data alignment:               8
Database block size:                  8192
Blocks per segment of large relation: 131072
WAL block size:                       8192
Bytes per WAL segment:                16777216
Maximum length of identifiers:        64
Maximum columns in an index:          32
Maximum size of a TOAST chunk:        1996
Size of a large-object chunk:         2048
Date/time type storage:               64-bit integers
Float4 argument passing:              by value
Float8 argument passing:              by value
Data page checksum version:           0
Mock authentication nonce:            b76ef4cc1642cbf88e6fff44c8a02a341834729c30f8ae683fd563312244c061
</code></pre></div></div>
<blockquote>
  <p>å¯åŠ¨æ•°æ®åº“
redoåº”ç”¨çš„LSNä¸ºï¼š1/7F8D4B80(<strong>å¤§äº1/7F8D4B10ï¼ˆæ£€æŸ¥ç‚¹LSNï¼‰ï¼Œç°è±¡è¡¨æ˜æ—¥å¿—åº”ç”¨ä¸ä¸€å®šä»æ£€æŸ¥å¼€å§‹ï¼Œä¹Ÿå¯èƒ½å»¶åä¸€äº›</strong>)</p>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2020-10-10 21:28:36.812 CST [2433] LOG:  database system was interrupted; last known up at 2020-10-10 21:23:00 CST
2020-10-10 21:28:36.857 CST [2433] LOG:  database system was not properly shut down; automatic recovery in progress
2020-10-10 21:28:36.858 CST [2433] LOG:  redo starts at 1/7F8D4B80
2020-10-10 21:28:37.883 CST [2433] LOG:  invalid record length at 1/89375790: wanted 24, got 0
2020-10-10 21:28:37.883 CST [2433] LOG:  redo done at 1/89375518
2020-10-10 21:28:37.883 CST [2433] LOG:  last completed transaction was at log time 2020-10-10 21:25:05.16881+08
2020-10-10 21:28:38.060 CST [2431] LOG:  database system is ready to accept connections
</code></pre></div>  </div>
</blockquote>

<blockquote>
  <p><strong>æ³¨æ„</strong>ï¼š
recoverè¿‡ç¨‹éå¤‡ä»½åŒºå—é‡åšä¸æ˜¯å¹‚ç­‰çš„ï¼Œå¤šæ¬¡é‡æ”¾å°†ä¼šå¯¼è‡´ä¸ä¸€è‡´ï¼Œ<strong><em>å¦å¤–recoverè¿‡ç¨‹ä¸ä¼šåšæ•°æ®æ–‡ä»¶ä¸€è‡´æ€§æ ¡éªŒï¼Œåªè¦LSNå¤§äºæ•°æ®å—çš„LSNå°±éœ€è¦åº”ç”¨æ—¥å¿—ï¼Œå¦‚æœæŠŠä¸€ä¸ªè€ç‰ˆæœ¬çš„æ•°æ®æ–‡ä»¶æ‹·è´åˆ°ä¸€ä¸ªcrashçš„å®ä¾‹ä¸‹ï¼Œæ£€æŸ¥ç‚¹ä¹‹åçš„æ—¥å¿—éƒ½ä¼šé‡åšä¸€éã€‚</em></strong></p>
</blockquote>

<blockquote>
  <blockquote>
    <p>æ³¨ï¼šåœ¨æ•°å­¦ä¸è®¡ç®—æœºå­¦ä¸­ï¼Œå¹‚ç­‰æ“ä½œæ˜¯æŒ‡å…¶æ‰§è¡Œä»»æ„å¤šæ¬¡æ‰€äº§ç”Ÿçš„å½±å“å‡ä¸æ‰§è¡Œä¸€æ¬¡ç›¸åŒï¼Œå³f(f(x))=f(x)ã€‚</p>
  </blockquote>
</blockquote>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>1ã€ç”±äºrecoverè¿‡ç¨‹å¹¶ä¸æ˜¯å…¨éƒ¨å¹‚ç­‰çš„ï¼Œå¤šæ¬¡åº”ç”¨æ—¥å¿—ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´
2ã€æ¢å¤çš„èµ·ç‚¹æ˜¯æ£€æŸ¥ç‚¹çš„LSN,ä½†æ˜¯æ¢å¤æ—¥å¿—ä¸­è¡¨ç°å‡ºæœ‰æ—¶æ¯”æ£€æŸ¥ç‚¹çš„LSNå¤§ä¸€äº›ã€‚
3ã€PGå¯åŠ¨æ²¡æœ‰éªŒè¯æ•°æ®æ–‡ä»¶çš„ä¸€è‡´æ€§ï¼Œè¾ƒè€çš„æ•°æ®æ–‡ä»¶ä¹Ÿå¯ä»¥æ­£å¸¸è¯»å–ã€‚</p>

:ET